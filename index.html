<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek èŠå¤©å°ç«™ Â· è¿ç»­å¯¹è¯</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #e6f0f5 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
        }
        .chat-card {
            max-width: 900px;
            width: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 2.5rem;
            box-shadow: 0 25px 45px -12px rgba(0, 20, 30, 0.3), 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.5);
            overflow: hidden;
            padding: 2rem 1.8rem 2rem 1.8rem;
        }
        h1 {
            font-size: 1.9rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: #1a2e3b;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.1rem;
        }
        .subhead {
            font-size: 0.95rem;
            color: #2f566b;
            margin-bottom: 1.5rem;
            border-left: 4px solid #3b8fc2;
            padding-left: 1rem;
            background: rgba(59, 143, 194, 0.06);
            border-radius: 0 8px 8px 0;
            line-height: 1.5;
        }
        .api-key-area {
            background: white;
            border-radius: 24px;
            padding: 1.2rem 1.5rem;
            margin-bottom: 1.8rem;
            box-shadow: 0 8px 18px -8px rgba(0,40,60,0.1);
            border: 1px solid #cbdae4;
        }
        .api-label {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 500;
            color: #0b3b4f;
            margin-bottom: 0.7rem;
        }
        .api-label svg {
            opacity: 0.7;
        }
        .key-input-wrapper {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }
        #apiKeyInput {
            flex: 1;
            padding: 0.9rem 1.2rem;
            border: 1px solid #b3cdde;
            border-radius: 40px;
            font-size: 0.95rem;
            background: #f1f7fb;
            transition: 0.2s;
            outline: none;
            color: #0a2c3b;
            min-width: 200px;
        }
        #apiKeyInput:focus {
            border-color: #1e7faf;
            background: white;
            box-shadow: 0 0 0 4px rgba(30,127,175,0.15);
        }
        .save-key-btn {
            background: #1e7faf;
            border: none;
            color: white;
            font-weight: 500;
            padding: 0.9rem 2rem;
            border-radius: 40px;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            transition: 0.15s;
            border: 1px solid #11638b;
            white-space: nowrap;
        }
        .save-key-btn:hover {
            background: #136a96;
            transform: scale(1.01);
            box-shadow: 0 8px 14px -8px #0b4b6b;
        }
        .warning-note {
            font-size: 0.85rem;
            color: #b8632c;
            margin-top: 0.7rem;
            background: #fff1e0;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            display: inline-block;
        }
        .chat-window {
            background: rgba(255,255,255,0.5);
            backdrop-filter: blur(4px);
            border-radius: 32px;
            padding: 1.5rem 1.2rem 1.2rem 1.2rem;
            border: 1px solid rgba(255,255,255,0.9);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        .messages-container {
            background: #ffffffd9;
            border-radius: 24px;
            padding: 1.5rem 1.2rem;
            min-height: 280px;
            max-height: 420px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            scroll-behavior: smooth;
            border: 1px solid #d7e2ea;
            box-shadow: 0 4px 12px rgba(0,20,30,0.03);
        }
        .message {
            margin-bottom: 1.2rem;
            display: flex;
            flex-direction: column;
        }
        .message.user {
            align-items: flex-end;
        }
        .message.assistant {
            align-items: flex-start;
        }
        .bubble {
            max-width: 80%;
            padding: 0.8rem 1.4rem;
            border-radius: 28px;
            font-size: 0.98rem;
            line-height: 1.5;
            word-break: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .user .bubble {
            background: #1e7faf;
            color: white;
            border-bottom-right-radius: 6px;
            border: 1px solid #116a96;
        }
        .assistant .bubble {
            background: #ecf3f8;
            color: #153e51;
            border-bottom-left-radius: 6px;
            border: 1px solid #c6dae7;
        }
        .timestamp {
            font-size: 0.7rem;
            color: #597f95;
            margin: 0.3rem 1rem 0;
            opacity: 0.8;
        }
        .input-area {
            display: flex;
            gap: 0.7rem;
            align-items: center;
            background: white;
            border-radius: 48px;
            padding: 0.3rem 0.3rem 0.3rem 1.5rem;
            border: 1px solid #bdd6e6;
            transition: 0.1s;
        }
        .input-area:focus-within {
            border-color: #1e7faf;
            box-shadow: 0 0 0 4px rgba(30,127,175,0.2);
        }
        #userInput {
            flex: 1;
            border: none;
            padding: 0.9rem 0;
            font-size: 1rem;
            background: transparent;
            outline: none;
            color: #1e3d4f;
        }
        #userInput::placeholder {
            color: #8aa9bf;
            font-weight: 300;
        }
        #sendBtn {
            background: #1e7faf;
            border: none;
            color: white;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.15s;
            border: 1px solid #0d5f89;
        }
        #sendBtn:hover:not(:disabled) {
            background: #0f6793;
            transform: scale(1.02);
        }
        #sendBtn:disabled {
            background: #b3c9d8;
            border-color: #93aebb;
            cursor: not-allowed;
        }
        .footer-note {
            margin-top: 1rem;
            font-size: 0.8rem;
            color: #3e6a82;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .clear-btn {
            background: none;
            border: 1px solid #b7cedf;
            padding: 0.3rem 1.2rem;
            border-radius: 30px;
            color: #2a5e7a;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.1s;
        }
        .clear-btn:hover {
            background: #d9e7f2;
            border-color: #7fa1bb;
        }
        .token-usage {
            background: #eaf3fb;
            padding: 0.3rem 1rem;
            border-radius: 30px;
        }
        .error-message {
            background: #ffdede;
            color: #b53b3b;
            padding: 0.7rem 1.5rem;
            border-radius: 40px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            border: 1px solid #ffb3b3;
        }
        .model-badge {
            background: #1e2f3b;
            color: #b2d6f0;
            padding: 0.2rem 0.9rem;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
    </style>
</head>
<body>
<div class="chat-card">
    <h1>
        <span>ğŸ§© DeepSeek åŠ©æ‰‹</span>
        <span class="model-badge">API Â· è¿ç»­å¯¹è¯</span>
    </h1>
    <div class="subhead">
        â‘  å¡«å…¥ä½ çš„ DeepSeek API Key â†’ â‘¡ å¼€å§‹èŠå¤©ï¼Œä¸Šä¸‹æ–‡è‡ªåŠ¨ä¿ç•™ï¼ˆæ¯æ¬¡å‘é€éƒ½ä¼šæºå¸¦å†å²è®°å½•ï¼‰
    </div>

    <!-- API KEY åŒºåŸŸ -->
    <div class="api-key-area">
        <div class="api-label">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1e7faf" stroke-width="1.8"><path d="M21 12v-2a5 5 0 0 0-5-5H8a5 5 0 0 0-5 5v2"/><circle cx="12" cy="16" r="5"/><path d="M12 11v5"/></svg>
            API å¯†é’¥ï¼ˆä¸ä¼šä¸Šä¼ ï¼Œä»…å­˜å‚¨åœ¨å½“å‰æµè§ˆå™¨ï¼‰
        </div>
        <div class="key-input-wrapper">
            <input type="password" id="apiKeyInput" placeholder="sk- æˆ–ç›´æ¥ç²˜è´´ä½ çš„ DeepSeek API Key" value="">
            <button class="save-key-btn" id="saveKeyBtn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h6"/><path d="M15 3h6v6"/><path d="M21 3 12 12"/></svg>
                ä¿å­˜å¯†é’¥
            </button>
        </div>
        <div class="warning-note">
            âš¡ å¯†é’¥åªä¿å­˜åœ¨ä½ æœ¬åœ°ï¼Œå¯éšæ—¶æ›´æ–°ã€‚API è°ƒç”¨ä¼šä»æµè§ˆå™¨ç›´æ¥å‘å¾€ DeepSeek æœåŠ¡å™¨ã€‚
        </div>
    </div>

    <!-- èŠå¤©ä¸»çª—å£ -->
    <div class="chat-window">
        <div id="messageContainer" class="messages-container">
            <!-- åˆå§‹æ¶ˆæ¯ç”±jsåŠ¨æ€æ¸²æŸ“ï¼Œä½†ä¹Ÿå¯ä»¥é¢„ç½®ä¸€æ¡æ¬¢è¿è¯­ -->
        </div>

        <!-- é”™è¯¯æç¤ºåŒº (åŠ¨æ€) -->
        <div id="errorBox" class="error-message" style="display: none;"></div>

        <!-- è¾“å…¥æ  -->
        <div class="input-area">
            <input type="text" id="userInput" placeholder="è¾“å…¥ä½ æƒ³é—® DeepSeek çš„æ¶ˆæ¯..." autocomplete="off">
            <button id="sendBtn" disabled title="è¯·å…ˆå¡«å†™å¹¶ä¿å­˜APIå¯†é’¥">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9 22 2z"/></svg>
            </button>
        </div>

        <div class="footer-note">
            <button class="clear-btn" id="clearChatBtn">ğŸ§¹ æ¸…ç©ºå¯¹è¯</button>
            <span class="token-usage" id="tokenCounter">â‰ˆ 0 tokens</span>
        </div>
    </div>
</div>

<script>
    (function() {
        // ---------- DOM å…ƒç´  ----------
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const sendBtn = document.getElementById('sendBtn');
        const userInput = document.getElementById('userInput');
        const messageContainer = document.getElementById('messageContainer');
        const errorBox = document.getElementById('errorBox');
        const clearBtn = document.getElementById('clearChatBtn');
        const tokenCounter = document.getElementById('tokenCounter');

        // ---------- çŠ¶æ€ ----------
        let savedApiKey = localStorage.getItem('deepseek_api_key') || '';   // ä»æœ¬åœ°å­˜å‚¨è¯»å–
        let messages = [];          // å¯¹è¯å†å² { role: 'user'/'assistant', content, timestamp? }
        let totalTokens = 0;         // ç®€å•ä¼°ç®—

        // ---------- å¸¸é‡ ----------
        const API_URL = 'https://api.deepseek.com/v1/chat/completions';

        // ---------- åˆå§‹åŒ–UI ----------
        function init() {
            // å¦‚æœæœ¬åœ°æœ‰keyï¼Œå›æ˜¾åˆ°è¾“å…¥æ¡†
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                enableSendButton(true);
            } else {
                enableSendButton(false);
            }

            // åŠ è½½æœ¬åœ°å­˜å‚¨çš„å¯¹è¯å†å²ï¼ˆå¯é€‰ç‰¹æ€§ï¼šé¡µé¢åˆ·æ–°åä¿ç•™å¯¹è¯ï¼‰
            loadHistoryFromStorage();

            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ·»åŠ ä¸€æ¡åŠ©æ‰‹æ¬¢è¿è¯­ï¼ˆä¿è¯ä¸ç©ºï¼‰
            if (messages.length === 0) {
                messages.push({
                    role: 'assistant',
                    content: 'ä½ å¥½ï¼æˆ‘æ˜¯ DeepSeekã€‚å·²ç»ä¿å­˜å¥½ API Key äº†å—ï¼Ÿè¯•è¯•é—®æˆ‘ç‚¹ä»€ä¹ˆå§ã€‚',
                    timestamp: Date.now()
                });
            }
            renderMessages();
            updateTokenEstimate();
        }

        // å¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®
        function enableSendButton(active) {
            sendBtn.disabled = !active;
        }

        // ---------- æœ¬åœ°å­˜å‚¨å†å² (å¯é€‰ï¼Œä¿æŒå¯¹è¯ä¸æ¶ˆå¤±) ----------
        const STORAGE_HISTORY_KEY = 'deepseek_chat_history';

        function saveHistoryToStorage() {
            try {
                const data = {
                    messages: messages,
                    totalTokens: totalTokens
                };
                localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(data));
            } catch (e) {}
        }

        function loadHistoryFromStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_HISTORY_KEY);
                if (raw) {
                    const obj = JSON.parse(raw);
                    if (obj.messages && Array.isArray(obj.messages)) {
                        messages = obj.messages;
                    }
                    if (typeof obj.totalTokens === 'number') {
                        totalTokens = obj.totalTokens;
                    }
                }
            } catch (e) {}
        }

        // ç®€å•tokenä¼°ç®— (å­—ç¬¦æ•°/2.5ï¼Œä»…ä½œå±•ç¤º)
        function estimateTokens(text) {
            return Math.round(text.length / 2.5);
        }

        function updateTokenEstimate() {
            let total = 0;
            messages.forEach(m => total += estimateTokens(m.content));
            totalTokens = total;
            tokenCounter.innerText = `â‰ˆ ${totalTokens} tokens (æœ¬ä¼šè¯)`;
        }

        // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
        function renderMessages() {
            let html = '';
            messages.forEach(msg => {
                const roleClass = msg.role === 'user' ? 'user' : 'assistant';
                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'ç¨å‰';
                html += `
                    <div class="message ${roleClass}">
                        <div class="bubble">${escapeHtml(msg.content)}</div>
                        <div class="timestamp">${time}</div>
                    </div>
                `;
            });
            messageContainer.innerHTML = html;
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // ç®€å•é˜²XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // æ˜¾ç¤ºé”™è¯¯ (çŸ­æš‚å‡ºç°ï¼Œå¯æ‰‹åŠ¨éšè—)
        function showError(text, isPersistent = false) {
            errorBox.style.display = 'block';
            errorBox.innerText = text;
            if (!isPersistent) {
                setTimeout(() => {
                    errorBox.style.display = 'none';
                }, 5000);
            }
        }

        function hideError() {
            errorBox.style.display = 'none';
        }

        // æ·»åŠ ä¸€æ¡æ¶ˆæ¯ (ä¸è°ƒç”¨API)
        function addLocalMessage(role, content) {
            messages.push({
                role: role,
                content: content,
                timestamp: Date.now()
            });
            renderMessages();
            updateTokenEstimate();
            saveHistoryToStorage();
        }

        // è°ƒç”¨ DeepSeek API
        async function callDeepSeekApi(userMessageContent) {
            // å‡†å¤‡å†å²æ¶ˆæ¯ (åªä¿ç•™ user/assistant äº¤æ›¿ï¼Œå¯é€‰å»é™¤å¤ªä¹…è¿œçš„ï¼Œä½†ä¿ç•™å…¨éƒ¨)
            const apiMessages = messages.map(m => ({
                role: m.role,
                content: m.content
            }));

            // æ·»åŠ å½“å‰æ–°æ¶ˆæ¯ (ä½†å°šæœªpushè¿›messages, æ‰€ä»¥éœ€è¦é¢å¤–åŒ…å«)
            const requestMessages = [
                ...apiMessages,
                { role: 'user', content: userMessageContent }
            ];

            // ç¡®ä¿æ²¡æœ‰è¿ç»­åŒè§’è‰²ä¹‹ç±»ï¼Œä½†DeepSeekå¯ä»¥å¤„ç†ï¼Œä¸ç®¡äº†

            const requestBody = {
                model: 'deepseek-chat',      // æˆ–è€… 'deepseek-reasoner' ç­‰
                messages: requestMessages,
                temperature: 0.9,
                stream: false,
                max_tokens: 1024,
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${savedApiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    let errorDetail = `HTTP ${response.status}`;
                    try {
                        const errData = await response.json();
                        errorDetail += ': ' + (errData.error?.message || JSON.stringify(errData));
                    } catch (e) {}
                    throw new Error(errorDetail);
                }

                const data = await response.json();
                const assistantReply = data.choices[0]?.message?.content || '[æ— å›å¤å†…å®¹]';
                return assistantReply;
            } catch (error) {
                console.error('API è°ƒç”¨å‡ºé”™:', error);
                throw error;
            }
        }

        // å¤„ç†å‘é€
        async function handleSend() {
            const userText = userInput.value.trim();
            if (!userText) return;
            if (!savedApiKey) {
                showError('è¯·å…ˆä¿å­˜æœ‰æ•ˆçš„ API å¯†é’¥', false);
                return;
            }

            // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œç¦ç”¨æŒ‰é’®
            userInput.value = '';
            sendBtn.disabled = true;

            // 1. å…ˆæŠŠç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ°ç•Œé¢
            addLocalMessage('user', userText);

            // 2. ä¸´æ—¶æ˜¾ç¤ºä¸€ä¸ªå ä½ (å¯é€‰, ç®€å•èµ·è§æˆ‘ä»¬ç›´æ¥è°ƒç”¨å¹¶æ·»åŠ åŠ©ç†æ¶ˆæ¯)
            // ä½†æˆ‘ä»¬ä¸å¸Œæœ›å¤šä¸ªå¹¶å‘ï¼Œæ‰€ä»¥å·²ç»åœ¨ç¦ç”¨æŒ‰é’®äº†

            try {
                // è°ƒç”¨API (ä¼šè‡ªåŠ¨ä½¿ç”¨åŒ…æ‹¬åˆšæ·»åŠ çš„useræ¶ˆæ¯åœ¨å†…çš„messages)
                // æ³¨æ„ï¼šcallDeepSeekApi å†…éƒ¨æ„é€ æ¶ˆæ¯æ—¶ä½¿ç”¨ç°åœ¨çš„ messages(å·²å«user) + é¢å¤–åŠ çš„userä¼šé‡å¤ã€‚éœ€è¦è°ƒæ•´ï¼
                // ä¿®æ­£: å› ä¸ºæˆ‘ä»¬å·²ç»æŠŠ user æ¶ˆæ¯ push è¿› messages äº†ï¼Œä¸èƒ½å†ä¼ ä¸€æ¬¡ã€‚
                // æ‰€ä»¥ callDeepSeekApi åº”è¯¥åªå–å½“å‰çš„ messages ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”APIä¼šè‡ªè¡Œè¡¥å…¨è§’è‰²ã€‚
                // é‡æ„: ä¸ä½¿ç”¨é¢å¤–å‚æ•°ï¼Œç›´æ¥ä» messages æ„å»ºã€‚
                async function fetchReply() {
                    const apiMessages = messages.map(m => ({ role: m.role, content: m.content }));
                    const body = {
                        model: 'deepseek-chat',
                        messages: apiMessages,
                        temperature: 0.8,
                    };

                    const resp = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${savedApiKey}`
                        },
                        body: JSON.stringify(body)
                    });
                    if (!resp.ok) {
                        const eData = await resp.json();
                        throw new Error(eData.error?.message || `è¯·æ±‚å¤±è´¥ ${resp.status}`);
                    }
                    const json = await resp.json();
                    return json.choices[0].message.content;
                }

                const reply = await fetchReply();
                // æ·»åŠ åŠ©æ‰‹å›å¤
                addLocalMessage('assistant', reply);
            } catch (err) {
                showError('API é”™è¯¯: ' + err.message, true);
                // å¯é€‰: ç§»é™¤åˆšåˆšçš„ç”¨æˆ·æ¶ˆæ¯ï¼Ÿ ä½†ä¸ºäº†ä½“éªŒï¼Œä¿ç•™ç”¨æˆ·æ¶ˆæ¯ä½†æç¤ºé”™è¯¯ã€‚
            } finally {
                sendBtn.disabled = false;
                if (savedApiKey) {
                    enableSendButton(true);
                }
                userInput.focus();
            }
        }

        // ---------- äº‹ä»¶ç»‘å®š ----------
        // ä¿å­˜å¯†é’¥
        saveKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                savedApiKey = key;
                localStorage.setItem('deepseek_api_key', key);
                enableSendButton(true);
                hideError();
                // å¯é€‰æç¤º
                showError('âœ“ å¯†é’¥å·²ä¿å­˜ (ä»…æœ¬åœ°)', false);
            } else {
                savedApiKey = '';
                localStorage.removeItem('deepseek_api_key');
                enableSendButton(false);
                showError('å¯†é’¥å·²æ¸…ç©º', false);
            }
        });

        // å‘é€æ¶ˆæ¯
        sendBtn.addEventListener('click', handleSend);

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendBtn.disabled) {
                    handleSend();
                }
            }
        });

        // æ¸…ç©ºå¯¹è¯
        clearBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å¯¹è¯æ¶ˆæ¯å—ï¼Ÿ')) {
                messages = [];
                totalTokens = 0;
                // å¯ä»¥åŠ ä¸€æ¡é»˜è®¤æ¬¢è¿è¯­
                messages.push({
                    role: 'assistant',
                    content: 'å¯¹è¯å·²é‡ç½®ã€‚æœ‰ä»€ä¹ˆæ–°é—®é¢˜ï¼Ÿ',
                    timestamp: Date.now()
                });
                renderMessages();
                updateTokenEstimate();
                saveHistoryToStorage();
            }
        });

        // å½“è¾“å…¥æ¡†æ£€æµ‹åˆ°å¯†é’¥å˜åŒ–æ—¶ï¼Œå¯ä»¥åŠ¨æ€æ”¹å˜ï¼Œä½†ä¸»è¦é ä¿å­˜æŒ‰é’®
        // è·¨æ ‡ç­¾åŒæ­¥keyç®€å•å¿½ç•¥

        // å¯åŠ¨
        init();

        // é¡µé¢å¸è½½å‰å­˜å‚¨å†å² (å…¶å®æ¯æ¬¡æ·»åŠ éƒ½å­˜äº†ï¼Œä½†ä¿é™©)
        window.addEventListener('beforeunload', () => {
            saveHistoryToStorage();
        });
    })();
</script>
</body>
</html>