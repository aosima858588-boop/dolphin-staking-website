// åœ¨ç°æœ‰æµ·è±šç¤¾åŒºç½‘ç«™çš„scriptæ ‡ç­¾ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç 

// é‚€è¯·ç³»ç»Ÿæ¨¡å—
class InviteSystem {
    constructor() {
        this.STORAGE_KEYS = {
            USER_CODE: 'dolphin_user_code',
            INVITES: 'dolphin_invites',
            TOTAL_INVITES: 'dolphin_total_invites',
            INVITE_HISTORY: 'dolphin_invite_history'
        };
        
        this.rewardLevels = [
            { level: 1, required: 3, reward: "$188 + 500Uç“œåˆ†é¢åº¦" },
            { level: 2, required: 5, reward: "$388 + 1000Uç“œåˆ†é¢åº¦" },
            { level: 3, required: 10, reward: "$888 + 3000Uç“œåˆ†é¢åº¦" }
        ];
        
        this.init();
    }
    
    init() {
        // ç¡®ä¿ç”¨æˆ·æœ‰é‚€è¯·ç 
        this.ensureUserCode();
        
        // æ£€æŸ¥URLä¸­çš„é‚€è¯·å‚æ•°
        this.checkUrlInvite();
        
        // æ›´æ–°é‚€è¯·ç»Ÿè®¡æ˜¾ç¤º
        this.updateInviteStats();
    }
    
    // ç¡®ä¿ç”¨æˆ·æœ‰é‚€è¯·ç 
    ensureUserCode() {
        let userCode = localStorage.getItem(this.STORAGE_KEYS.USER_CODE);
        if (!userCode) {
            userCode = this.generateInviteCode();
            localStorage.setItem(this.STORAGE_KEYS.USER_CODE, userCode);
        }
        return userCode;
    }
    
    // ç”Ÿæˆé‚€è¯·ç 
    generateInviteCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 6; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    }
    
    // æ£€æŸ¥URLä¸­çš„é‚€è¯·å‚æ•°
    checkUrlInvite() {
        const urlParams = new URLSearchParams(window.location.search);
        const inviteCode = urlParams.get('invite');
        
        if (inviteCode) {
            // è®°å½•é‚€è¯·å…³ç³»
            this.recordInvitation(inviteCode);
            
            // ä»URLä¸­ç§»é™¤é‚€è¯·å‚æ•°
            this.removeInviteParam();
        }
    }
    
    // è®°å½•é‚€è¯·å…³ç³»
    recordInvitation(inviterCode) {
        try {
            // è·å–é‚€è¯·å†å²
            let inviteHistory = localStorage.getItem(this.STORAGE_KEYS.INVITE_HISTORY);
            inviteHistory = inviteHistory ? JSON.parse(inviteHistory) : [];
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«é‚€è¯·è¿‡
            const alreadyInvited = inviteHistory.some(record => 
                record.inviterCode === inviterCode
            );
            
            if (!alreadyInvited) {
                // æ·»åŠ æ–°çš„é‚€è¯·è®°å½•
                const newRecord = {
                    inviterCode: inviterCode,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent.substring(0, 100)
                };
                
                inviteHistory.push(newRecord);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem(this.STORAGE_KEYS.INVITE_HISTORY, JSON.stringify(inviteHistory));
                
                // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                this.showInviteWelcome(inviterCode);
            }
        } catch (error) {
            console.error('è®°å½•é‚€è¯·å…³ç³»å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºé‚€è¯·æ¬¢è¿æ¶ˆæ¯
    showInviteWelcome(inviterCode) {
        const welcomeDiv = document.createElement('div');
        welcomeDiv.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #2D8CFF, #64FFDA);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9999;
            max-width: 300px;
            animation: slideInRight 0.5s ease;
        `;
        
        welcomeDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px;">ğŸ‰ æ¬¢è¿åŠ å…¥æµ·è±šç¤¾åŒºï¼</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">
                æ‚¨æ˜¯é€šè¿‡é‚€è¯·ç  <strong>${inviterCode}</strong> åŠ å…¥çš„
            </div>
            <div style="margin-top: 10px; font-size: 0.8rem;">
                å¼€å§‹å‚ä¸Boostæ´»åŠ¨ï¼Œä¸é‚€è¯·äººä¸€èµ·è·å¾—å¥–åŠ±ï¼
            </div>
            <button onclick="this.parentElement.remove()" style="
                position: absolute;
                top: 10px;
                right: 10px;
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                font-size: 1.2rem;
            ">Ã—</button>
        `;
        
        document.body.appendChild(welcomeDiv);
        
        // 10ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            if (welcomeDiv.parentElement) {
                welcomeDiv.style.animation = 'slideOutRight 0.5s ease';
                setTimeout(() => welcomeDiv.remove(), 500);
            }
        }, 10000);
    }
    
    // ä»URLä¸­ç§»é™¤é‚€è¯·å‚æ•°
    removeInviteParam() {
        const url = new URL(window.location);
        url.searchParams.delete('invite');
        window.history.replaceState({}, document.title, url.toString());
    }
    
    // è·å–ç”¨æˆ·é‚€è¯·ç 
    getUserInviteCode() {
        return localStorage.getItem(this.STORAGE_KEYS.USER_CODE) || this.generateInviteCode();
    }
    
    // è·å–é‚€è¯·ç»Ÿè®¡æ•°æ®
    getInviteStats() {
        const invites = parseInt(localStorage.getItem(this.STORAGE_KEYS.INVITES) || '0');
        const totalInvites = parseInt(localStorage.getItem(this.STORAGE_KEYS.TOTAL_INVITES) || '0');
        const history = JSON.parse(localStorage.getItem(this.STORAGE_KEYS.INVITE_HISTORY) || '[]');
        
        // è®¡ç®—å¥–åŠ±æ€»é¢
        let totalRewards = 0;
        if (invites >= 3) totalRewards += 188;
        if (invites >= 5) totalRewards += 388;
        if (invites >= 10) totalRewards += 888;
        
        return {
            invites: invites,
            totalInvites: totalInvites,
            totalRewards: totalRewards,
            history: history,
            userCode: this.getUserInviteCode()
        };
    }
    
    // æ¨¡æ‹Ÿæ·»åŠ é‚€è¯·ï¼ˆå¼€å‘æµ‹è¯•ç”¨ï¼‰
    simulateInvite(friendName = `å¥½å‹${Date.now().toString().slice(-4)}`) {
        const userCode = this.getUserInviteCode();
        const stats = this.getInviteStats();
        
        // æ›´æ–°é‚€è¯·æ•°
        const newInvites = stats.invites + 1;
        const newTotalInvites = stats.totalInvites + 1;
        
        localStorage.setItem(this.STORAGE_KEYS.INVITES, newInvites.toString());
        localStorage.setItem(this.STORAGE_KEYS.TOTAL_INVITES, newTotalInvites.toString());
        
        // æ›´æ–°é‚€è¯·å†å²
        const newRecord = {
            friendName: friendName,
            timestamp: new Date().toISOString(),
            code: userCode,
            status: 'å·²æ³¨å†Œ'
        };
        
        const history = [...stats.history, newRecord];
        localStorage.setItem(this.STORAGE_KEYS.INVITE_HISTORY, JSON.stringify(history));
        
        this.updateInviteStats();
        
        // æ˜¾ç¤ºé€šçŸ¥
        this.showNotification(`æˆåŠŸé‚€è¯· ${friendName}ï¼`);
        
        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å¥–åŠ±ç­‰çº§
        this.checkRewardLevel(newInvites);
        
        return newRecord;
    }
    
    // æ£€æŸ¥å¥–åŠ±ç­‰çº§
    checkRewardLevel(currentInvites) {
        this.rewardLevels.forEach(level => {
            if (currentInvites === level.required) {
                this.showLevelUpNotification(level);
            }
        });
    }
    
    // æ˜¾ç¤ºå‡çº§é€šçŸ¥
    showLevelUpNotification(level) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            z-index: 9999;
            text-align: center;
            animation: popIn 0.5s ease;
            max-width: 400px;
        `;
        
        notification.innerHTML = `
            <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ‰</div>
            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 10px;">
                æ­å–œï¼è¾¾åˆ°é‚€è¯·ç­‰çº§ ${level.level}
            </div>
            <div style="font-size: 1.2rem; margin-bottom: 20px;">
                è·å¾—å¥–åŠ±ï¼š${level.reward}
            </div>
            <button onclick="this.parentElement.remove()" style="
                background: #000;
                color: #FFD700;
                border: none;
                padding: 10px 30px;
                border-radius: 10px;
                cursor: pointer;
                font-weight: bold;
            ">å¤ªæ£’äº†ï¼</button>
        `;
        
        document.body.appendChild(notification);
        
        // 8ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.animation = 'popOut 0.5s ease';
                setTimeout(() => notification.remove(), 500);
            }
        }, 8000);
    }
    
    // æ›´æ–°é‚€è¯·ç»Ÿè®¡æ˜¾ç¤º
    updateInviteStats() {
        const stats = this.getInviteStats();
        
        // å¦‚æœæœ‰æ˜¾ç¤ºé‚€è¯·ç»Ÿè®¡çš„å…ƒç´ ï¼Œæ›´æ–°å®ƒä»¬
        const inviteCountElements = document.querySelectorAll('[data-invite-count]');
        inviteCountElements.forEach(el => {
            el.textContent = stats.invites;
        });
        
        const totalRewardElements = document.querySelectorAll('[data-total-rewards]');
        totalRewardElements.forEach(el => {
            el.textContent = `$${stats.totalRewards}`;
        });
        
        const inviteCodeElements = document.querySelectorAll('[data-invite-code]');
        inviteCodeElements.forEach(el => {
            el.textContent = stats.userCode;
        });
        
        // æ›´æ–°è¿›åº¦æ¡
        this.updateProgressBar(stats.invites);
    }
    
    // æ›´æ–°è¿›åº¦æ¡
    updateProgressBar(currentInvites) {
        const progressBars = document.querySelectorAll('[data-progress-bar]');
        
        progressBars.forEach(progressBar => {
            let progress = 0;
            
            if (currentInvites < 3) {
                progress = (currentInvites / 3) * 100;
            } else if (currentInvites < 5) {
                progress = ((currentInvites - 3) / 2) * 100;
            } else if (currentInvites < 10) {
                progress = ((currentInvites - 5) / 5) * 100;
            } else {
                progress = 100;
            }
            
            const fill = progressBar.querySelector('[data-progress-fill]');
            if (fill) {
                fill.style.width = `${progress}%`;
            }
            
            const currentCount = progressBar.querySelector('[data-current-count]');
            if (currentCount) {
                currentCount.textContent = currentInvites;
            }
        });
    }
    
    // æ˜¾ç¤ºé€šçŸ¥
    showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #64FFDA;
            color: #0A192F;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        `;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // åˆ›å»ºé‚€è¯·é“¾æ¥
    createInviteLink() {
        const userCode = this.getUserInviteCode();
        return `${window.location.origin}${window.location.pathname}?invite=${userCode}`;
    }
    
    // åˆ†äº«é‚€è¯·
    shareInvite() {
        const inviteLink = this.createInviteLink();
        const userCode = this.getUserInviteCode();
        
        if (navigator.share) {
            navigator.share({
                title: 'åŠ å…¥æµ·è±šç¤¾åŒºï¼Œä¸€èµ·é“¾ä¸Šèµšå¸ï¼',
                text: `ä½¿ç”¨æˆ‘çš„é‚€è¯·ç  ${userCode} åŠ å…¥æµ·è±šç¤¾åŒºï¼Œå‚ä¸OKX Boostæ´»åŠ¨ï¼Œè·å¾—ä¸°åšå¥–åŠ±ï¼`,
                url: inviteLink
            });
        } else {
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(`${inviteLink}\né‚€è¯·ç ï¼š${userCode}`).then(() => {
                this.showNotification('é‚€è¯·é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }
    }
}

// åˆå§‹åŒ–é‚€è¯·ç³»ç»Ÿ
let inviteSystem;

document.addEventListener('DOMContentLoaded', () => {
    inviteSystem = new InviteSystem();
    
    // æ·»åŠ é‚€è¯·ç³»ç»ŸUIå…ƒç´ 
    addInviteUI();
});

// æ·»åŠ é‚€è¯·ç³»ç»ŸUI
function addInviteUI() {
    // åœ¨ä¾¿æ·è®¿é—®å…¥å£éƒ¨åˆ†æ·»åŠ é‚€è¯·å¡ç‰‡
    const resourcesSection = document.querySelector('#resources .card-content');
    if (resourcesSection) {
        const inviteCard = document.createElement('div');
        inviteCard.className = 'content-card';
        inviteCard.style.marginTop = '20px';
        inviteCard.style.background = 'rgba(45, 140, 255, 0.1)';
        inviteCard.style.border = '1px solid rgba(45, 140, 255, 0.3)';
        
        inviteCard.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <div style="width: 50px; height: 50px; background: rgba(45, 140, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #2D8CFF; font-size: 1.5rem;">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h3 style="margin: 0; color: var(--text-light);">é‚€è¯·å¥½å‹èµšå¥–åŠ±</h3>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">æ‚¨çš„é‚€è¯·ç </div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #64FFDA; letter-spacing: 2px;" data-invite-code>åŠ è½½ä¸­...</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">å·²é‚€è¯·</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2D8CFF;" data-invite-count>0</div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">é‚€è¯·è¿›åº¦</div>
                    <div style="height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden;">
                        <div data-progress-fill style="height: 100%; background: linear-gradient(90deg, #2D8CFF, #64FFDA); border-radius: 5px; width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8rem; color: var(--text-tertiary);">
                        <span>å½“å‰: <span data-current-count>0</span>äºº</span>
                        <span>ä¸‹ä¸€çº§: <span data-next-level>3</span>äºº</span>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="inviteSystem.shareInvite()" style="
                    flex: 1;
                    background: linear-gradient(135deg, #2D8CFF, #64FFDA);
                    color: white;
                    border: none;
                    padding: 15px;
                    border-radius: 12px;
                    font-weight: bold;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                ">
                    <i class="fas fa-share-alt"></i>
                    <span>åˆ†äº«é‚€è¯·</span>
                </button>
                <button onclick="inviteSystem.simulateInvite()" style="
                    background: rgba(255,255,255,0.1);
                    color: white;
                    border: 1px solid rgba(255,255,255,0.2);
                    padding: 15px;
                    border-radius: 12px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                " title="æµ‹è¯•åŠŸèƒ½">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                    <strong>ğŸ¯ é‚€è¯·å¥–åŠ±ï¼š</strong>
                    <div style="margin-top: 10px;">
                        <div>â€¢ é‚€è¯·3äººï¼š$188 Hå¸ + 500Uç“œåˆ†é¢åº¦</div>
                        <div>â€¢ é‚€è¯·5äººï¼š$388 Hå¸ + 1000Uç“œåˆ†é¢åº¦</div>
                        <div>â€¢ é‚€è¯·10äººï¼š$888 Hå¸ + 3000Uç“œåˆ†é¢åº¦</div>
                    </div>
                </div>
            </div>
        `;
        
        resourcesSection.appendChild(inviteCard);
        
        // æ›´æ–°UIæ•°æ®
        setTimeout(() => {
            inviteSystem.updateInviteStats();
        }, 100);
    }
}

// æ·»åŠ CSSåŠ¨ç”»
const inviteStyles = document.createElement('style');
inviteStyles.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    @keyframes popIn {
        from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
        to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    @keyframes popOut {
        from { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        to { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    }
`;
document.head.appendChild(inviteStyles);
